name: Acceptance Tests

on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Confirm running acceptance tests'
        required: true
        default: 'false'

permissions:
  contents: read

jobs:
  acceptance:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.run_tests == 'true'

    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: P@ssw0rd123!
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'P@ssw0rd123!' -Q 'SELECT 1' -C || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Run acceptance tests
        env:
          TF_ACC: "1"
          MSSQL_HOSTNAME: localhost
          MSSQL_PORT: "1433"
        run: go test -v -timeout 30m ./internal/provider/...
